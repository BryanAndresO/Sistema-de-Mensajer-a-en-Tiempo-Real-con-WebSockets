<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat WebSocket Distribuido</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-fondo: #f7f9fc;
      --color-contenedor: #ffffff;
      --color-chat: #eef2f7;
      --color-burbuja-propia: #007bff;
      --color-burbuja-ajena: #e9eaf2;
      --color-texto-propio: #ffffff;
      --color-texto-ajeno: #333333;
      --color-texto-principal: #1c1e21;
      --color-texto-secundario: #606770;
      --color-primario: #007bff;
      --color-borde: #dce1e6;
      --sombra: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
    * {
      box-sizing: border-box;
    }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--color-fondo);
      margin: 0;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    #contenedor {
      width: 100%;
      max-width: 480px;
      height: 95vh;
      max-height: 800px;
      background: var(--color-contenedor);
      border-radius: 24px;
      box-shadow: var(--sombra);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    #header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--color-borde);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    #header h2 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--color-texto-principal);
    }
    #estado-servidor {
      font-size: 0.8rem;
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 12px;
    }
    #estado-servidor.conectado {
      background-color: #d4edda;
      color: #155724;
    }
    #estado-servidor.desconectado {
      background-color: #f8d7da;
      color: #721c24;
    }
    #chat {
      flex-grow: 1;
      background-color: var(--color-chat);
      padding: 15px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .mensaje {
      display: flex;
      animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .burbuja {
      padding: 10px 16px;
      border-radius: 20px;
      max-width: 75%;
      word-wrap: break-word;
      line-height: 1.4;
      min-width: 150px;
    }
    .mensaje.propio {
      justify-content: flex-end;
    }
    .mensaje.propio .burbuja {
      background-color: var(--color-burbuja-propia);
      color: var(--color-texto-propio);
      border-bottom-right-radius: 6px;
    }
    .mensaje.ajeno {
      justify-content: flex-start;
    }
    .mensaje.ajeno .burbuja {
      background-color: var(--color-burbuja-ajena);
      color: var(--color-texto-ajeno);
      border-bottom-left-radius: 6px;
    }
    .mensaje.sistema {
      align-self: center;
      font-size: 0.8rem;
      color: var(--color-texto-secundario);
      background-color: #e0e0e0;
      padding: 4px 10px;
      border-radius: 12px;
    }
    #area-login, #area-mensaje {
      padding: 15px 20px;
      border-top: 1px solid var(--color-borde);
      background-color: var(--color-contenedor);
      display: flex;
      gap: 10px;
      align-items: center;
    }
    input[type="text"] {
      flex-grow: 1;
      padding: 12px 18px;
      border: 1px solid var(--color-borde);
      border-radius: 24px;
      font-size: 1rem;
      background-color: #f0f2f5;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: var(--color-primario);
      background-color: var(--color-contenedor);
    }
    input[type="text"]:disabled {
      background-color: #e9ecef;
    }
    button {
      padding: 12px;
      border: none;
      background: var(--color-primario);
      color: white;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      transition: background-color 0.2s, transform 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 48px;
      height: 48px;
      flex-shrink: 0;
    }
    button:hover {
      background: #0056b3;
      transform: scale(1.05);
    }
    button:disabled {
      background-color: #a0a0a0;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <div id="contenedor">
    <div id="header">
      <h2>ðŸ’¬ Chat Global</h2>
      <span id="estado-servidor"></span>
    </div>
    <div id="chat"></div>
    <div id="area-login">
      <input id="usuario" type="text" placeholder="Tu nombre de usuario..." maxlength="20">
    </div>
    <div id="area-mensaje" style="display: none;">
      <input id="mensaje" type="text" placeholder="Escribe un mensaje..." maxlength="200">
      <button id="btn-enviar" title="Enviar Mensaje">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
      </button>
    </div>
  </div>

  <script>
    let socket;
    let usuario;

    const areaLogin = document.getElementById('area-login');
    const areaMensaje = document.getElementById('area-mensaje');
    const inputUsuario = document.getElementById('usuario');
    const inputMensaje = document.getElementById('mensaje');
    const btnEnviar = document.getElementById('btn-enviar');
    const chat = document.getElementById('chat');
    const estadoServidor = document.getElementById('estado-servidor');

    document.addEventListener('DOMContentLoaded', () => {
      actualizarEstado('Desconectado', false);
      inputMensaje.disabled = true;
      btnEnviar.disabled = true;
      inputUsuario.focus();
    });

    inputUsuario.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        registrarUsuario();
      }
    });

    function registrarUsuario() {
      const nombreUsuario = inputUsuario.value.trim();
      if (nombreUsuario.length < 3) {
        mostrarAlerta("El nombre de usuario debe tener al menos 3 caracteres.");
        return;
      }
      usuario = nombreUsuario;
      areaLogin.style.display = 'none';
      areaMensaje.style.display = 'flex';
      inputMensaje.disabled = false;
      btnEnviar.disabled = false;
      inputMensaje.focus();
      conectar();
    }

    function conectar() {
      // LÃ³gica simplificada y robusta para la conexiÃ³n WebSocket.
      // Siempre usa la ubicaciÃ³n del host desde donde se sirve la pÃ¡gina.
      const contextPath = window.location.pathname.substring(0, window.location.pathname.indexOf("/", 2));
      const wsUrl = `ws://${window.location.host}${contextPath}/chat`;
      console.log(`Intentando conectar a: ${wsUrl}`);
      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        console.log("âœ… Conectado al servidor WebSocket");
        actualizarEstado('Conectado', true);
        agregarMensaje(`${usuario} te has unido al chat.`, "sistema");
        socket.send(`@${usuario} se ha unido.`);
      };

      socket.onmessage = (event) => {
        const mensajeCompleto = event.data;
        
        if (mensajeCompleto.startsWith("@")) {
            agregarMensaje(mensajeCompleto.substring(1), "sistema");
            return;
        }

        // Limpiamos el emoji "ðŸ’¬ " que aÃ±ade el servidor para poder analizar el mensaje.
        const mensajeLimpio = mensajeCompleto.startsWith("ðŸ’¬ ") ? mensajeCompleto.substring(2) : mensajeCompleto;

        // Formato esperado: "14:17 - JEFE: Hola" o "2:17 p. m. - JEFE: Hola"
        // Regex mÃ¡s flexible que captura la hora, el usuario y el contenido
        const match = mensajeLimpio.match(/^(.+?)\s+-\s+(.+?):\s+(.*)$/);
        if (!match) {
            // Si el formato no coincide, lo tratamos como mensaje de sistema
            agregarMensaje(mensajeCompleto, "sistema");
            return;
        }
        
        const horaExtracted = match[1].trim();
        const infoRemitente = match[2].trim();
        const contenido = match[3].trim();

        const tipo = (infoRemitente === usuario) ? 'propio' : 'ajeno';

        // Ahora mostramos todos los mensajes (propios y ajenos) con la hora
        agregarMensaje(contenido, tipo, infoRemitente, horaExtracted);
      };

      socket.onclose = () => {
        console.log("ðŸ”´ Desconectado del servidor WebSocket");
        actualizarEstado('Desconectado', false);
        agregarMensaje("Te has desconectado. Recarga la pÃ¡gina para volver a conectar.", "sistema");
        inputMensaje.disabled = true;
        btnEnviar.disabled = true;
      };

      socket.onerror = (error) => {
        console.error("Error de WebSocket:", error);
        actualizarEstado('Error', false);
        agregarMensaje("Error de conexiÃ³n. No se pudo conectar al servidor.", "sistema");
      };
    }

    function enviar() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        mostrarAlerta("No estÃ¡s conectado al chat. Intenta recargar la pÃ¡gina.");
        return;
      }
      const texto = inputMensaje.value.trim();
      if (texto.length > 0 && texto.length <= 200) {
        const hora = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const mensaje = `${hora} - ${usuario}: ${texto}`;
        socket.send(mensaje);
        // NO mostramos el mensaje inmediatamente, esperamos a que el servidor lo reenvÃ­e
        inputMensaje.value = "";
        inputMensaje.focus();
      } else if (texto.length > 200) {
        mostrarAlerta("El mensaje es demasiado largo (mÃ¡ximo 200 caracteres).");
      }
    }

    btnEnviar.addEventListener('click', enviar);
    inputMensaje.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        enviar();
      }
    });

    function agregarMensaje(texto, tipo, remitente = '', horaCompleta = '') {
      const divMensaje = document.createElement('div');
      divMensaje.classList.add('mensaje', tipo);

      const contenidoSanitizado = sanitizarHTML(texto);

      if (tipo === 'sistema') {
        divMensaje.textContent = contenidoSanitizado;
      } else {
        // Siempre crea una burbuja para mensajes propios y ajenos
        const divBurbuja = document.createElement('div');
        divBurbuja.classList.add('burbuja');
        
        if (remitente) {
          // Obtener hora actual si no se proporciona
          const hora = horaCompleta || new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
          
          if (tipo === 'propio') {
            // Mensajes propios: nombre en blanco y hora
            divBurbuja.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <strong style="color: #ffffff; font-size: 0.9rem;">${sanitizarHTML(remitente)}</strong>
                <span style="color: rgba(255, 255, 255, 0.7); font-size: 0.75rem; margin-left: 10px;">${hora}</span>
              </div>
              <div>${contenidoSanitizado}</div>
            `;
          } else {
            // Mensajes ajenos: nombre en azul y hora
            divBurbuja.innerHTML = `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                <strong style="color: var(--color-primario); font-size: 0.9rem;">${sanitizarHTML(remitente)}</strong>
                <span style="color: var(--color-texto-secundario); font-size: 0.75rem; margin-left: 10px;">${hora}</span>
              </div>
              <div>${contenidoSanitizado}</div>
            `;
          }
        } else {
          // Si no hay remitente (caso raro), solo muestra el contenido
          divBurbuja.innerHTML = contenidoSanitizado;
        }
        divMensaje.appendChild(divBurbuja);
      }
      
      chat.appendChild(divMensaje);
      chat.scrollTop = chat.scrollHeight;
    }

    function actualizarEstado(texto, conectado) {
      estadoServidor.textContent = texto;
      estadoServidor.className = 'estado-servidor';
      estadoServidor.classList.add(conectado ? 'conectado' : 'desconectado');
    }

    function sanitizarHTML(str) {
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }

    function mostrarAlerta(mensaje) {
      // Reemplaza el alert nativo por algo mÃ¡s sutil en el futuro
      alert(mensaje);
    }

  </script>
</body>
</html>